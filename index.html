<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WhatsApp Bot Multi-Device Manager</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
        color: white;
        padding: 25px 30px;
        text-align: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .main-content {
        display: flex;
        flex-wrap: wrap;
        padding: 30px;
        gap: 20px;
      }

      .sidebar {
        flex: 1;
        min-width: 300px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
      }

      .device-list {
        list-style: none;
        padding: 0;
      }

      .device-item {
        background: #f9f9f9;
        margin-bottom: 10px;
        padding: 15px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.03);
        transition: transform 0.2s ease;
      }

      .device-item:hover {
        transform: translateY(-3px);
      }

      .device-item-info {
        flex-grow: 1;
      }

      .device-name {
        font-weight: bold;
        color: #333;
        font-size: 1.1em;
      }

      .device-status {
        font-size: 0.9em;
        color: #666;
        margin-top: 5px;
      }

      .status-connected {
        color: #28a745;
      }

      .status-disconnected {
        color: #dc3545;
      }

      .status-connecting {
        color: #ffc107;
      }

      .device-actions button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 8px;
        transition: background-color 0.2s ease;
      }

      .device-actions button:hover {
        background-color: #0056b3;
      }

      .device-actions .btn-danger {
        background-color: #dc3545;
      }

      .device-actions .btn-danger:hover {
        background-color: #c82333;
      }

      .device-actions .btn-success {
        background-color: #28a745;
      }

      .device-actions .btn-success:hover {
        background-color: #218838;
      }

      .device-actions .btn-info {
        background-color: #17a2b8;
      }

      .device-actions .btn-info:hover {
        background-color: #138496;
      }

      .content-area {
        flex: 2;
        min-width: 400px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
      }

      .section-title {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.5em;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: bold;
      }

      .form-group input[type="text"],
      .form-group input[type="number"],
      .form-group textarea {
        width: calc(100% - 22px);
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        transition: border-color 0.2s ease;
      }

      .form-group input[type="text"]:focus,
      .form-group input[type="number"]:focus,
      .form-group textarea:focus {
        border-color: #007bff;
        outline: none;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .btn-primary {
        background-color: #25d366;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        transition: background-color 0.2s ease;
        width: 100%;
      }

      .btn-primary:hover {
        background-color: #128c7e;
      }

      .alert-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        width: 300px;
      }

      .alert {
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        font-weight: bold;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        animation: fadeIn 0.5s ease-out;
      }

      .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .alert-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Modals */
      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 30px;
        border-radius: 15px;
        width: 80%;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        position: relative;
        text-align: center;
      }

      .close-button {
        color: #aaa;
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
      }

      .close-button:hover,
      .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      #qrCodeContainer {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 200px;
        background-color: #eee;
        border-radius: 10px;
      }

      .qr-code {
        max-width: 100%;
        height: auto;
      }

      #sendBulkMessageForm {
        margin-top: 20px;
      }

      #sendBulkMessageForm textarea {
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <div class="alert-container" id="alertContainer"></div>

    <div class="container">
      <header class="header">
        <h1>WhatsApp Bot Multi-Device Manager</h1>
        <p>Kelola dan kendalikan akun WhatsApp bot Anda dengan mudah.</p>
      </header>

      <main class="main-content">
        <section class="sidebar">
          <h2 class="section-title">Devices</h2>
          <button
            class="btn-primary"
            onclick="openModal('addDeviceModal')"
            style="margin-bottom: 20px"
          >
            + Add New Device
          </button>
          <ul class="device-list" id="deviceList">
            </ul>
        </section>

        <section class="content-area">
          <h2 class="section-title">Actions</h2>

          <div class="form-group">
            <label for="selectedDeviceId">Selected Device ID:</label>
            <input
              type="text"
              id="selectedDeviceId"
              placeholder="Select a device from the left"
              readonly
            />
          </div>

          <div class="form-group">
            <label for="messageNumber">Recipient Number (e.g., 62812xxxxxx):</label>
            <input type="text" id="messageNumber" placeholder="Enter recipient number" />
          </div>

          <div class="form-group">
            <label for="messageText">Message:</label>
            <textarea
              id="messageText"
              placeholder="Enter your message here"
            ></textarea>
          </div>

          <button class="btn-primary" id="sendMessageBtn">Send Message</button>
          <button
            class="btn-primary"
            id="openBulkMessageModalBtn"
            style="background-color: #ffc107; margin-top: 10px"
          >
            Send Bulk Message
          </button>
          <button
            class="btn-danger"
            id="logoutDeviceBtn"
            style="margin-top: 10px"
          >
            Logout Device
          </button>
        </section>
      </main>
    </div>

    <div id="addDeviceModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal('addDeviceModal')"
          >&times;</span
        >
        <h2>Add New Device</h2>
        <form id="addDeviceForm">
          <div class="form-group">
            <label for="newDeviceId">Device ID:</label>
            <input
              type="text"
              id="newDeviceId"
              placeholder="Enter a unique device ID (e.g., device-1)"
              required
            />
          </div>
          <button type="submit" class="btn-primary">Create Device</button>
        </form>
      </div>
    </div>

    <div id="qrCodeModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal('qrCodeModal')"
          >&times;</span
        >
        <h2>Scan QR Code</h2>
        <p>Please scan this QR code with your WhatsApp app.</p>
        <div id="qrCodeContainer">
          <p>Loading QR Code...</p>
        </div>
        <p class="device-status" id="qrDeviceStatus"></p>
        <p class="info-message" id="qrInfoMessage" style="font-size: 0.9em; color: #555; margin-top: 10px;"></p>
      </div>
    </div>

    <div id="bulkMessageModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal('bulkMessageModal')"
          >&times;</span
        >
        <h2>Send Bulk Message</h2>
        <form id="sendBulkMessageForm">
          <div class="form-group">
            <label for="bulkNumbers">Recipient Numbers (one per line, e.g., 62812xxxxxx):</label>
            <textarea
              id="bulkNumbers"
              placeholder="Enter recipient numbers here, one per line"
            ></textarea>
          </div>
          <div class="form-group">
            <label for="bulkMessageText">Message:</label>
            <textarea
              id="bulkMessageText"
              placeholder="Enter your message here"
            ></textarea>
          </div>
          <button type="submit" class="btn-primary">Send Bulk</button>
        </form>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:4001/api"; // Adjust if your backend is on a different port/domain
      const API_KEY = "YOUR_SUPER_SECRET_API_KEY"; // GANTI DENGAN API KEY YANG SAMA DENGAN DI index.js

      let selectedDeviceId = null;
      let qrInterval = null;

      // Helper to open modals
      function openModal(modalId) {
        document.getElementById(modalId).style.display = "flex";
      }

      // Helper to close modals
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
        if (modalId === "qrCodeModal" && qrInterval) {
          clearInterval(qrInterval);
          qrInterval = null;
        }
      }

      // API Call Wrapper
      async function apiCall(endpoint, options = {}) {
        try {
          const headers = {
            "Content-Type": "application/json",
            ...options.headers,
          };

          let fetchOptions = {
            headers: headers,
            ...options,
          };

          // If it's a GET request, remove the 'body' from fetchOptions to prevent issues
          if (options.method === 'GET' && fetchOptions.body) {
            delete fetchOptions.body;
          }

          const response = await fetch(`${endpoint}`, fetchOptions);

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: "Unknown error" }));
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || response.statusText}`);
          }

          return await response.json();
        } catch (error) {
          console.error("API Error:", error);
          showAlert("Error: " + error.message, "error");
          throw error;
        }
      }

      // Load Devices
      async function loadDevices() {
        try {
          const devices = await apiCall(`${API_BASE}/devices?apikey=${API_KEY}`, { method: "GET" }); // GET request with apikey as query param
          const deviceList = document.getElementById("deviceList");
          deviceList.innerHTML = ""; // Clear existing list

          if (devices.status === "success" && devices.data.length > 0) {
            devices.data.forEach((device) => {
              const li = document.createElement("li");
              li.className = "device-item";
              li.innerHTML = `
                <div class="device-item-info">
                  <span class="device-name">${device.id}</span>
                  <span class="device-status status-${device.status.toLowerCase()}">${device.status}</span>
                </div>
                <div class="device-actions">
                  <button class="btn-info" onclick="selectDevice('${device.id}', '${device.status}')">Select</button>
                  <button class="btn-success" onclick="openQRCodeModal('${device.id}')">QR Code</button>
                  <button class="btn-danger" onclick="deleteDevice('${device.id}')">Delete</button>
                </div>
              `;
              deviceList.appendChild(li);
            });
          } else {
            deviceList.innerHTML = "<p>No devices found. Add a new one!</p>";
          }
        } catch (error) {
          showAlert("Failed to load devices: " + error.message, "error");
        }
      }

      // Select Device
      function selectDevice(deviceId, status) {
        selectedDeviceId = deviceId;
        document.getElementById("selectedDeviceId").value = deviceId;
        showAlert(`Device '${deviceId}' selected. Status: ${status}`, "info");
      }

      // Add Device
      document.getElementById("addDeviceForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const newDeviceId = document.getElementById("newDeviceId").value;
        showAlert(`Creating device '${newDeviceId}'...`, "info");
        try {
          const response = await apiCall(`${API_BASE}/devices`, {
            method: "POST",
            body: JSON.stringify({ device_id: newDeviceId, apikey: API_KEY }),
          });
          if (response.status === "success") {
            showAlert(`Device '${newDeviceId}' created successfully!`, "success");
            closeModal("addDeviceModal");
            loadDevices();
          } else {
            showAlert(`Failed to create device: ${response.message}`, "error");
          }
        } catch (error) {
          showAlert("Error creating device: " + error.message, "error");
        }
      });

      // Delete Device
      async function deleteDevice(deviceId) {
        if (!confirm(`Are you sure you want to delete device '${deviceId}'?`)) {
          return;
        }
        showAlert(`Deleting device '${deviceId}'...`, "info");
        try {
          const response = await apiCall(`${API_BASE}/device`, {
            method: "DELETE",
            body: JSON.stringify({ device_id: deviceId, apikey: API_KEY }),
          });
          if (response.status === "success") {
            showAlert(`Device '${deviceId}' deleted successfully!`, "success");
            loadDevices();
            if (selectedDeviceId === deviceId) {
              selectedDeviceId = null;
              document.getElementById("selectedDeviceId").value = "";
            }
          } else {
            showAlert(`Failed to delete device: ${response.message}`, "error");
          }
        } catch (error) {
          showAlert("Error deleting device: " + error.message, "error");
        }
      }

      // Load QR Code for selected device
      async function loadQRCode(deviceId) {
        try {
          const qrCodeContainer = document.getElementById("qrCodeContainer");
          const qrDeviceStatus = document.getElementById("qrDeviceStatus");
          const qrInfoMessage = document.getElementById("qrInfoMessage");

          qrCodeContainer.innerHTML = "<p>Loading QR Code...</p>";
          qrDeviceStatus.textContent = "Status: Connecting...";
          qrInfoMessage.textContent = "Awaiting QR code from server. Make sure device is not already connected.";

          // Construct URL with query parameters for GET request
          const urlWithParams = `${API_BASE}/device/qr?device_id=${deviceId}&apikey=${API_KEY}`;
          const response = await apiCall(urlWithParams, {
            method: "GET",
            // Remove the body for GET requests
          });

          if (response.qr_code) {
            qrCodeContainer.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(
              response.qr_code
            )}" alt="QR Code" class="qr-code">`;
            qrDeviceStatus.textContent = "Status: QR Code Available";
            qrInfoMessage.textContent = response.message || "Scan this QR code with your WhatsApp app.";
            showAlert("QR Code loaded successfully!", "success");
          } else {
            qrCodeContainer.innerHTML = "<p>QR Code not available.</p>";
            qrDeviceStatus.textContent = "Status: No QR Code";
            qrInfoMessage.textContent = response.message || "Device might be already authenticated or an error occurred.";
            showAlert("QR Code not available. Device might be ready or there was an error.", "info");
          }
        } catch (error) {
          document.getElementById("qrCodeContainer").innerHTML =
            "<p>Error loading QR Code. Device might be ready or there was an error.</p>";
          document.getElementById("qrDeviceStatus").textContent = "Status: Error";
          document.getElementById("qrInfoMessage").textContent = "Check console for details or try again.";
          showAlert("Error loading QR Code: " + error.message, "error");
        }
      }

      function openQRCodeModal(deviceId) {
        if (qrInterval) {
          clearInterval(qrInterval);
        }
        openModal("qrCodeModal");
        loadQRCode(deviceId); // Load immediately
        qrInterval = setInterval(() => loadQRCode(deviceId), 10000); // Refresh every 10 seconds
      }

      // Send Single Message
      document.getElementById("sendMessageBtn").addEventListener("click", async () => {
        if (!selectedDeviceId) {
          showAlert("Please select a device first.", "error");
          return;
        }
        const number = document.getElementById("messageNumber").value;
        const message = document.getElementById("messageText").value;

        if (!number || !message) {
          showAlert("Please enter both recipient number and message.", "error");
          return;
        }

        showAlert(`Sending message to ${number} using ${selectedDeviceId}...`, "info");
        await sendMessage(selectedDeviceId, number, message);
      });

      async function sendMessage(deviceId, number, message) {
        try {
          const response = await apiCall(`${API_BASE}/device/send-message`, {
            method: "POST",
            body: JSON.stringify({
              device_id: deviceId,
              number: number,
              message: message,
              apikey: API_KEY,
            }),
          });
          if (response.status === "success") {
            showAlert(`Message sent to ${number} successfully!`, "success");
          } else {
            showAlert(`Failed to send message to ${number}: ${response.message}`, "error");
          }
        } catch (error) {
          showAlert(`Error sending message to ${number}: ` + error.message, "error");
        }
      }

      // Logout Device
      document.getElementById("logoutDeviceBtn").addEventListener("click", async () => {
        if (!selectedDeviceId) {
          showAlert("Please select a device first.", "error");
          return;
        }
        if (!confirm(`Are you sure you want to logout device '${selectedDeviceId}'?`)) {
          return;
        }
        showAlert(`Logging out device '${selectedDeviceId}'...`, "info");
        try {
          const response = await apiCall(`${API_BASE}/device/logout`, {
            method: "POST",
            body: JSON.stringify({ device_id: selectedDeviceId, apikey: API_KEY }),
          });
          if (response.status === "success") {
            showAlert(`Device '${selectedDeviceId}' logged out successfully!`, "success");
            loadDevices(); // Refresh device list to show status change
          } else {
            showAlert(`Failed to logout device: ${response.message}`, "error");
          }
        } catch (error) {
          showAlert("Error logging out device: " + error.message, "error");
        }
      });

      // Open Bulk Message Modal
      document.getElementById("openBulkMessageModalBtn").addEventListener("click", () => {
        if (!selectedDeviceId) {
          showAlert("Please select a device first to send bulk messages.", "error");
          return;
        }
        openModal("bulkMessageModal");
      });

      // Send Bulk Message
      document.getElementById("sendBulkMessageForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const bulkNumbersText = document.getElementById("bulkNumbers").value;
        const message = document.getElementById("bulkMessageText").value;
        const deviceId = selectedDeviceId;

        if (!deviceId) {
          showAlert("No device selected for bulk messaging.", "error");
          return;
        }
        if (!bulkNumbersText || !message) {
          showAlert("Please enter recipient numbers and message for bulk sending.", "error");
          return;
        }

        const numbers = bulkNumbersText.split(/\r?\n/).filter((n) => n.trim() !== "");

        showAlert(`Sending bulk messages to ${numbers.length} recipients...`, "info");

        let successful = 0;
        let failed = 0;

        for (const number of numbers) {
          try {
            await sendMessage(deviceId, number.trim(), message);
            successful++;
            await new Promise((resolve) => setTimeout(resolve, 2000)); // 2 second delay between messages
          } catch (error) {
            failed++;
          }
        }

        showAlert(
          `Bulk message completed: ${successful} successful, ${failed} failed`,
          successful > 0 ? "success" : "error"
        );
        closeModal("bulkMessageModal");
        e.target.reset();
      });

      // Close modals when clicking outside
      window.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal")) {
          e.target.style.display = "none";
          if (qrInterval) {
            clearInterval(qrInterval);
            qrInterval = null;
          }
        }
      });

      // Alert Function
      function showAlert(message, type = "info") {
        const alertContainer = document.getElementById("alertContainer");
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;

        alertContainer.appendChild(alertDiv);

        setTimeout(() => {
          alertDiv.remove();
        }, 5000);
      }

      // Initial load
      document.addEventListener("DOMContentLoaded", loadDevices);
    </script>
  </body>
</html>